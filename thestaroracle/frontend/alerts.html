<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alerts - The Star Oracle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background: #0a0a1a; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar { background: linear-gradient(180deg, rgba(10, 10, 26, 0.95) 0%, rgba(26, 26, 58, 0.95) 100%); border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-item { transition: all 0.3s ease; }
        .nav-item:hover, .nav-item.active { background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; }
        .toggle-switch { transition: all 0.3s ease; }
        .toggle-switch.active { background: linear-gradient(135deg, #667eea, #764ba2); }
        .toggle-switch.active .toggle-dot { transform: translateX(20px); }
        .toggle-dot { transition: transform 0.3s ease; }
        .timeline-line { background: linear-gradient(180deg, #667eea, #764ba2, #ff4757); }
    </style>
</head>
<body class="min-h-screen text-white">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar fixed left-0 top-0 h-full w-64 z-40">
            <div class="p-6">
                <a href="index.html" class="flex items-center space-x-3 mb-8">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                    </div>
                    <span class="text-lg font-poppins font-bold gradient-text">STAR ORACLE</span>
                </a>
                
                <nav class="space-y-2">
                    <a href="dashboard.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="live-feed.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        <span>Live Feed</span>
                    </a>
                    <a href="risk-analysis.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        <span>Risk Analysis</span>
                    </a>
                    <a href="alerts.html" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                        <span>Alerts</span>
                    </a>
                    <a href="orbit-3d.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                        <span>3D Orbits</span>
                    </a>
                </nav>
                
                <div class="absolute bottom-6 left-6 right-6">
                    <button id="logoutBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-red-400 hover:bg-red-500/10 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="ml-64 flex-1 p-8">
            <header class="mb-8">
                <h1 class="text-3xl font-poppins font-bold mb-1">Alerts & Notifications</h1>
                <p class="text-gray-400">Manage your asteroid monitoring alerts</p>
            </header>
            
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Alerts List -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Upcoming Close Approaches -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-poppins font-bold flex items-center space-x-2">
                                <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span>Upcoming Close Approaches</span>
                            </h2>
                            <button onclick="fetchUpcomingAlerts()" class="text-orange-400 hover:text-orange-300 transition" title="Refresh">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            </button>
                        </div>
                        <div id="upcomingAlerts" class="space-y-3">
                            <!-- Alerts will be loaded here -->
                        </div>
                        <!-- Pagination for Upcoming Alerts -->
                        <div id="upcomingPagination" class="mt-4 pt-4 border-t border-gray-700/50" style="display: none;">
                            <div class="flex items-center justify-center gap-3">
                                <div class="text-xs text-gray-400 whitespace-nowrap">
                                    <span id="upcomingShowingStart">0</span>-<span id="upcomingShowingEnd">0</span> of <span id="upcomingTotal">0</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="upcomingPrevPage" class="p-1.5 rounded-lg bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                    </button>
                                    <button id="upcomingNextPage" class="p-1.5 rounded-lg bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Watchlist Alerts -->
                    <div class="glass rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-poppins font-bold flex items-center space-x-2">
                                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                                <span>Watchlist Alerts</span>
                            </h2>
                            <div class="flex items-center space-x-3">
                                <span id="watchlistCount" class="text-sm text-gray-400">0 items</span>
                                <button onclick="loadWatchlistAlerts()" class="text-indigo-400 hover:text-indigo-300 transition" title="Refresh">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                </button>
                            </div>
                        </div>
                        <div id="watchlistAlerts" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">No watchlist alerts</p>
                        </div>
                    </div>
                    
                    <!-- Event Timeline -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="text-xl font-poppins font-bold mb-6">Event Timeline</h2>
                        <div class="relative">
                            <div class="absolute left-4 top-0 bottom-0 w-0.5 timeline-line"></div>
                            <div id="timeline" class="space-y-6 pl-12">
                                <!-- Timeline events will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Sidebar Panels -->
                <div class="space-y-6">
                    <!-- Today's Quick Stats -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="text-xl font-poppins font-bold mb-5 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            <span>Today's Summary</span>
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-cyan-500/10 border border-cyan-500/20 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-cyan-400" id="statTotal">--</p>
                                <p class="text-xs text-gray-400 mt-1">Total NEOs</p>
                            </div>
                            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-red-400" id="statHazardous">--</p>
                                <p class="text-xs text-gray-400 mt-1">Hazardous</p>
                            </div>
                            <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-purple-400" id="statClosest">--</p>
                                <p class="text-xs text-gray-400 mt-1">Closest (LD)</p>
                            </div>
                            <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-orange-400" id="statFastest">--</p>
                                <p class="text-xs text-gray-400 mt-1">Fastest (km/s)</p>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-indigo-500/10 border border-indigo-500/20 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-400">Your Watchlist</span>
                                <span class="text-lg font-bold text-indigo-400" id="statWatchlist">--</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-1.5 mt-2">
                                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-1.5 rounded-full" id="watchlistBar" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Asteroids -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="text-xl font-poppins font-bold mb-5 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <span>Search Asteroid</span>
                        </h2>
                        <div class="relative">
                            <input type="text" id="asteroidSearch" placeholder="Enter asteroid name or ID..." class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition pr-10">
                            <button onclick="searchAsteroid()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-indigo-400 transition p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </button>
                        </div>
                        <div id="searchResults" class="mt-3 space-y-2 max-h-60 overflow-y-auto"></div>
                        <p class="text-xs text-gray-500 mt-3">Search by NASA SPK-ID (e.g. 3542519) or name</p>
                    </div>
                    
                    <!-- Danger Zone - Top Threats -->
                    <div class="glass rounded-xl p-6">
                        <h2 class="text-xl font-poppins font-bold mb-5 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            <span>Top Threats Today</span>
                        </h2>
                        <div id="topThreats" class="space-y-3">
                            <p class="text-gray-500 text-sm text-center py-2">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const NASA_API_KEY = 'QQ7SB7m487vCmeNr9KHy26qgYxrhFBKDrksYwEaO';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // Auth check
        if (!token) {
            window.location.replace('index.html');
        } else {
            window.history.pushState(null, '', window.location.href);
            window.onpopstate = function() {
                if (!localStorage.getItem('token')) {
                    window.location.replace('index.html');
                } else {
                    window.history.pushState(null, '', window.location.href);
                }
            };
        }
        
        let allAsteroids = [];
        let upcomingCurrentPage = 1;
        let upcomingItemsPerPage = 3;
        
        // ====== FETCH DATA FROM NASA API DIRECTLY ======
        async function fetchUpcomingAlerts() {
            const upcomingDiv = document.getElementById('upcomingAlerts');
            upcomingDiv.innerHTML = '<p class="text-gray-400 text-center py-4"><svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Loading...</p>';
            
            try {
                // Use current date and 7 days ahead
                const today = new Date();
                const endDateObj = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                const startDate = today.toISOString().split('T')[0];
                const endDate = endDateObj.toISOString().split('T')[0];
                
                // Use backend API instead of direct NASA call
                const apiUrl = `../backend/api/asteroids.php?start_date=${startDate}&end_date=${endDate}`;
                console.log('Fetching from backend API:', apiUrl);
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error('Backend API error: ' + response.status + ' ' + response.statusText);
                }
                
                const data = await response.json();
                console.log('Backend API response:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch asteroid data');
                }
                
                // Process the data from backend API
                allAsteroids = data.asteroids || [];
                
                if (allAsteroids.length === 0) {
                    upcomingDiv.innerHTML = '<p class="text-yellow-400 text-center py-4">No asteroid data available for the selected date range.</p>';
                    renderStats(data, allAsteroids);
                    return;
                }
                
                try {
                    renderUpcomingAlerts(allAsteroids);
                } catch (e) {
                    console.error('Error rendering upcoming alerts:', e);
                }
                
                try {
                    renderTimeline(allAsteroids);
                } catch (e) {
                    console.error('Error rendering timeline:', e);
                }
                
                try {
                    renderStats(data, allAsteroids);
                } catch (e) {
                    console.error('Error rendering stats:', e);
                }
                
                try {
                    renderTopThreats(allAsteroids);
                } catch (e) {
                    console.error('Error rendering top threats:', e);
                }
                
            } catch (error) {
                console.error('Error loading asteroid data:', error);
                upcomingDiv.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-red-400 mb-3">Failed to load asteroid data: ${error.message}</p>
                        <button onclick="fetchUpcomingAlerts()" class="px-4 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded-lg transition">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // ====== RENDER UPCOMING APPROACHES ======
        function renderUpcomingAlerts(asteroids) {
            const upcomingDiv = document.getElementById('upcomingAlerts');
            const sorted = [...asteroids]
                .filter(a => a.close_approach && a.close_approach.distance_km != null)
                .sort((a, b) => a.close_approach.distance_km - b.close_approach.distance_km);
            
            if (!sorted.length) {
                upcomingDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming close approaches found</p>';
                document.getElementById('upcomingPagination').style.display = 'none';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(sorted.length / upcomingItemsPerPage);
            const startIdx = (upcomingCurrentPage - 1) * upcomingItemsPerPage;
            const endIdx = Math.min(startIdx + upcomingItemsPerPage, sorted.length);
            const paginatedAlerts = sorted.slice(startIdx, endIdx);
            
            // Update pagination info
            document.getElementById('upcomingTotal').textContent = sorted.length;
            document.getElementById('upcomingShowingStart').textContent = startIdx + 1;
            document.getElementById('upcomingShowingEnd').textContent = endIdx;
            
            // Update pagination buttons
            document.getElementById('upcomingPrevPage').disabled = upcomingCurrentPage === 1;
            document.getElementById('upcomingNextPage').disabled = upcomingCurrentPage === totalPages;
            
            // Show pagination
            document.getElementById('upcomingPagination').style.display = 'block';
            
            upcomingDiv.innerHTML = paginatedAlerts.map(a => {
                const approachDate = a.close_approach?.date_full || a.close_approach?.date;
                const distLD = a.close_approach?.distance_lunar ? a.close_approach.distance_lunar.toFixed(2) : 'N/A';
                const velKms = a.close_approach?.velocity_kms ? a.close_approach.velocity_kms.toFixed(1) + ' km/s' : '';
                const score = a.risk_score || 0;
                
                let formattedDate = 'N/A';
                if (approachDate) {
                    try {
                        formattedDate = new Date(approachDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
                    } catch (e) {
                        formattedDate = approachDate;
                    }
                }

                // Risk-based badge using the backend risk_score
                let bgClass, borderClass, hoverClass, dotClass, badgeBg, badgeText, badgeLabel;
                if (score > 80 || a.is_hazardous) {
                    bgClass = 'bg-red-500/10'; borderClass = 'border-red-500/30'; hoverClass = 'hover:bg-red-500/20';
                    dotClass = 'bg-red-400 animate-pulse'; badgeBg = 'bg-red-500/20'; badgeText = 'text-red-400';
                    badgeLabel = 'HAZARDOUS';
                } else if (score > 60) {
                    bgClass = 'bg-red-500/10'; borderClass = 'border-red-500/30'; hoverClass = 'hover:bg-red-500/20';
                    dotClass = 'bg-red-400'; badgeBg = 'bg-red-500/20'; badgeText = 'text-red-400';
                    badgeLabel = 'HIGH RISK';
                } else if (score > 40) {
                    bgClass = 'bg-orange-500/10'; borderClass = 'border-orange-500/30'; hoverClass = 'hover:bg-orange-500/20';
                    dotClass = 'bg-orange-400'; badgeBg = 'bg-orange-500/20'; badgeText = 'text-orange-400';
                    badgeLabel = 'MODERATE';
                } else if (score > 20) {
                    bgClass = 'bg-yellow-500/10'; borderClass = 'border-yellow-500/30'; hoverClass = 'hover:bg-yellow-500/20';
                    dotClass = 'bg-yellow-400'; badgeBg = 'bg-yellow-500/20'; badgeText = 'text-yellow-400';
                    badgeLabel = 'LOW RISK';
                } else {
                    bgClass = 'bg-green-500/10'; borderClass = 'border-green-500/30'; hoverClass = 'hover:bg-green-500/20';
                    dotClass = 'bg-green-400'; badgeBg = 'bg-green-500/20'; badgeText = 'text-green-400';
                    badgeLabel = 'SAFE';
                }
                
                return `
                    <div class="flex items-center justify-between p-4 rounded-lg ${bgClass} border ${borderClass} ${hoverClass} cursor-pointer transition" onclick="window.location.href='asteroid-detail.html?id=${a.id}'">
                        <div class="flex items-center space-x-4 flex-1">
                            <div class="w-3 h-3 rounded-full ${dotClass}"></div>
                            <div class="flex-1">
                                <p class="font-semibold text-sm">${a.name}</p>
                                <p class="text-xs text-gray-400">${formattedDate} &bull; ${distLD} LD${velKms ? ' &bull; ' + velKms : ''}</p>
                            </div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded ${badgeBg} ${badgeText} whitespace-nowrap ml-2">${badgeLabel}</span>
                    </div>
                `;
            }).join('');
        }
        

        
        // ====== RENDER TIMELINE ======
        function renderTimeline(asteroids) {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;
            
            const top6 = [...asteroids]
                .filter(a => a.close_approach)
                .sort((a, b) => {
                    const da = new Date(a.close_approach.date_full || a.close_approach.date || 0);
                    const db = new Date(b.close_approach.date_full || b.close_approach.date || 0);
                    return da - db;
                }).slice(0, 6);
            
            // Static color pairs (Tailwind JIT needs literal class names)
            const palette = [
                { dot: 'bg-cyan-500',   text: 'text-cyan-400' },
                { dot: 'bg-purple-500', text: 'text-purple-400' },
                { dot: 'bg-green-500',  text: 'text-green-400' },
                { dot: 'bg-orange-500', text: 'text-orange-400' },
                { dot: 'bg-red-500',    text: 'text-red-400' },
                { dot: 'bg-blue-500',   text: 'text-blue-400' }
            ];
            
            timeline.innerHTML = top6.length ? top6.map((a, i) => {
                const c = palette[i % palette.length];
                const dateStr = a.close_approach.date_full || a.close_approach.date
                    ? new Date(a.close_approach.date_full || a.close_approach.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
                    : 'N/A';
                const distance = a.close_approach.distance_km ? (a.close_approach.distance_km / 1000000).toFixed(2) : 'N/A';
                const velocity = a.close_approach.velocity_kms ? a.close_approach.velocity_kms.toFixed(1) : 'N/A';
                return `
                    <div class="relative cursor-pointer" onclick="window.location.href='asteroid-detail.html?id=${a.id}'">
                        <div class="absolute -left-10 w-4 h-4 rounded-full ${c.dot} border-4 border-gray-900"></div>
                        <div class="glass rounded-lg p-4 hover:bg-white/5 transition">
                            <p class="text-sm ${c.text}">${dateStr}</p>
                            <p class="font-semibold mt-1 text-sm">${a.name}</p>
                            <p class="text-xs text-gray-400">Distance: ${distance}M km &bull; ${velocity} km/s</p>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 text-center py-2">No timeline data</p>';
        }
        
        // ====== RENDER QUICK STATS ======
        function renderStats(data, asteroids) {
            const stats = data.stats || {};
            document.getElementById('statTotal').textContent = stats.total_count || asteroids.length;
            document.getElementById('statHazardous').textContent = stats.hazardous_count || asteroids.filter(a => a.is_hazardous).length;
            
            if (stats.closest_asteroid) {
                document.getElementById('statClosest').textContent = (stats.closest_asteroid.distance_lunar || 0).toFixed(1);
            } else {
                const closest = [...asteroids].sort((a, b) => a.distance_lunar - b.distance_lunar)[0];
                document.getElementById('statClosest').textContent = closest ? closest.distance_lunar.toFixed(1) : '--';
            }
            
            if (stats.fastest_asteroid) {
                document.getElementById('statFastest').textContent = (stats.fastest_asteroid.velocity_kms || 0).toFixed(1);
            } else {
                const fastest = [...asteroids].sort((a, b) => b.velocity_kms - a.velocity_kms)[0];
                document.getElementById('statFastest').textContent = fastest ? fastest.velocity_kms.toFixed(1) : '--';
            }
        }
        
        // ====== RENDER TOP THREATS ======
        function renderTopThreats(asteroids) {
            const threatsDiv = document.getElementById('topThreats');
            const hazardous = asteroids.filter(a => a.is_hazardous).sort((a, b) => (a.close_approach?.distance_km || 0) - (b.close_approach?.distance_km || 0)).slice(0, 4);
            
            threatsDiv.innerHTML = hazardous.length ? hazardous.map(a => {
                const distLD = a.close_approach?.distance_lunar ? a.close_approach.distance_lunar.toFixed(2) : 'N/A';
                const velocity = a.close_approach?.velocity_kms ? a.close_approach.velocity_kms.toFixed(1) : 'N/A';
                return `
                    <div class="flex items-center space-x-3 p-3 rounded-lg bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 cursor-pointer transition" onclick="window.location.href='asteroid-detail.html?id=${a.id}'">
                        <div class="w-2 h-2 rounded-full bg-red-400 animate-pulse"></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${a.name}</p>
                            <p class="text-xs text-gray-400">${distLD} LD &bull; ${velocity} km/s</p>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </div>
                `;
            }).join('') : '<p class="text-green-400 text-sm text-center py-2">No hazardous asteroids detected today</p>';
        }
        
        // ====== WATCHLIST FROM DATABASE ======
        async function loadWatchlistAlerts() {
            try {
                const response = await fetch('../backend/api/watchlist.php?action=list', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                console.log('Watchlist response:', data);
                
                if (data.success) {
                    renderWatchlistAlerts(data.data);
                    updateWatchlistStat(data.data.length);
                } else {
                    throw new Error(data.error || 'Failed to load watchlist');
                }
            } catch (error) {
                console.warn('Watchlist API error, falling back to localStorage:', error);
                const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
                renderWatchlistAlerts(watchlist);
                updateWatchlistStat(watchlist.length);
            }
        }
        
        function updateWatchlistStat(count) {
            const el = document.getElementById('statWatchlist');
            const bar = document.getElementById('watchlistBar');
            if (el) el.textContent = count;
            if (bar) bar.style.width = Math.min(count * 10, 100) + '%';
        }
        
        function renderWatchlistAlerts(watchlist) {
            const watchlistDiv = document.getElementById('watchlistAlerts');
            const countElement = document.getElementById('watchlistCount');
            
            const items = Array.isArray(watchlist) ? watchlist : [];
            countElement.textContent = `${items.length} item${items.length !== 1 ? 's' : ''}`;
            
            if (items.length === 0) {
                watchlistDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No watchlist items. Add asteroids from the detail page.</p>';
                return;
            }
            
            watchlistDiv.innerHTML = items.map(item => {
                const id = item.asteroid_id || item.id;
                const name = item.asteroid_name || item.name || 'Unknown';
                const addedDate = item.added_at ? new Date(item.added_at).toLocaleDateString() : (item.added_date ? new Date(item.added_date).toLocaleDateString() : 'N/A');
                
                return `
                    <div class="flex items-center justify-between p-4 rounded-lg bg-indigo-500/10 border border-indigo-500/30 hover:bg-indigo-500/20 cursor-pointer transition" onclick="window.location.href='asteroid-detail.html?id=${id}'">
                        <div class="flex items-center space-x-4 flex-1">
                            <div class="w-3 h-3 rounded-full bg-indigo-400"></div>
                            <div class="flex-1">
                                <p class="font-semibold text-sm">${name}</p>
                                <p class="text-xs text-gray-400">Added: ${addedDate}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 rounded bg-indigo-500/20 text-indigo-400">TRACKING</span>
                            <button onclick="removeFromWatchlist('${id}'); event.stopPropagation();" class="text-gray-500 hover:text-red-400 transition p-1" title="Remove">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ====== REMOVE FROM WATCHLIST ======
        function removeFromWatchlist(asteroidId) {
            if (!confirm('Remove this asteroid from your watchlist?')) return;
            
            fetch('../backend/api/watchlist.php?action=remove', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ asteroid_id: asteroidId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadWatchlistAlerts();
                } else {
                    alert('Failed to remove: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Remove error:', err);
                let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
                watchlist = watchlist.filter(item => (item.id || item.asteroid_id) !== asteroidId);
                localStorage.setItem('watchlist', JSON.stringify(watchlist));
                loadWatchlistAlerts();
            });
        }
        
        // ====== SEARCH ASTEROID BY ID ======
        async function searchAsteroid() {
            const query = document.getElementById('asteroidSearch').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            resultsDiv.innerHTML = '<p class="text-gray-400 text-sm">Searching...</p>';
            
            try {
                // Try direct lookup by ID first
                const res = await fetch(`https://api.nasa.gov/neo/rest/v1/neo/${query}?api_key=${NASA_API_KEY}`);
                if (res.ok) {
                    const a = await res.json();
                    resultsDiv.innerHTML = `
                        <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/20 hover:bg-cyan-500/20 cursor-pointer transition" onclick="window.location.href='asteroid-detail.html?id=${a.id}'">
                            <p class="font-semibold text-sm">${a.name}</p>
                            <p class="text-xs text-gray-400">ID: ${a.id} &bull; ${a.is_potentially_hazardous_asteroid ? '<span class=text-red-400>Hazardous</span>' : '<span class=text-green-400>Safe</span>'}</p>
                        </div>
                    `;
                    return;
                }
                
                // If not found by ID, search in loaded data by name
                const matches = allAsteroids.filter(a => a.name.toLowerCase().includes(query.toLowerCase()));
                if (matches.length > 0) {
                    resultsDiv.innerHTML = matches.slice(0, 5).map(a => {
                        const ld = a.close_approach?.distance_lunar ? a.close_approach.distance_lunar.toFixed(2) : 'N/A';
                        return `
                            <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/20 hover:bg-cyan-500/20 cursor-pointer transition" onclick="window.location.href='asteroid-detail.html?id=${a.id}'">
                                <p class="font-semibold text-sm">${a.name}</p>
                                <p class="text-xs text-gray-400">ID: ${a.id} &bull; ${ld} LD</p>
                            </div>
                        `;
                    }).join('');
                } else {
                    resultsDiv.innerHTML = '<p class="text-gray-500 text-sm">No results found. Try a NASA SPK-ID number.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-400 text-sm">Search failed. Try again.</p>';
            }
        }
        
        // Search on Enter key
        document.getElementById('asteroidSearch')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') searchAsteroid();
        });
        
        // ====== LOGOUT ======
        document.getElementById('logoutBtn').addEventListener('click', () => {
            fetch('../backend/api/logout.php', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            }).catch(() => {});
            
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.clear();
            window.location.replace('index.html');
        });
        
        // ====== PAGINATION CONTROLS FOR UPCOMING ALERTS ======
        document.getElementById('upcomingPrevPage').addEventListener('click', () => {
            if (upcomingCurrentPage > 1) {
                upcomingCurrentPage--;
                renderUpcomingAlerts(allAsteroids);
            }
        });
        
        document.getElementById('upcomingNextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(allAsteroids.length / upcomingItemsPerPage);
            if (upcomingCurrentPage < totalPages) {
                upcomingCurrentPage++;
                renderUpcomingAlerts(allAsteroids);
            }
        });
        
        // ====== INIT ======
        fetchUpcomingAlerts();
        loadWatchlistAlerts();
        // Auto-refresh watchlist alerts every 5 minutes
        setInterval(loadWatchlistAlerts, 300000);
    </script>
</body>
</html>
